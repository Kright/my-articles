Когда я раньше задумывался о вращении в 3д, мне было неуютно. Оно казалось сложным. Вспомнить, например, эффект Джанибекова с прецессией свободно вращающейся гайки. Настало время это исправить!

Крутящий момент:

$M = r \times F$

Момент импульса:

$L = r \times P = I w$

Кинетическая энергия вращения:

$E = \frac{1}{2} w \cdot (I w)$



У тела есть [момент инерции](https://ru.wikipedia.org/wiki/%D0%9C%D0%BE%D0%BC%D0%B5%D0%BD%D1%82_%D0%B8%D0%BD%D0%B5%D1%80%D1%86%D0%B8%D0%B8) $I$. Если тело не является шаром или кубом, то вдоль разных осей момент может быть разным. В общем случае $I$ - тензор с 9 чиселками. С помощью поворота его всегда можно привести к диагональной форме с тремя числами вокруг трёх главных осей.

Пусть w - угловая скорость, e - угловое ускорение, m - крутящий момент:
$$I e + w \times (I w) = m$$
$$I e = m - w \times (I w) $$
$$e = I^{-1} (m - w \times (I w)) $$

Кроме того, нужно чётко понимать, в какой системе проводятся эти вычисления. Если тело как-то повёрнуто (допустим, матрицей $R$), то в глобальной системе отсчёта $I$ преобразуется: $$ I_{global} = R I_{local} R^{-1} $$

В виде кода у меня получилось так:

```scala
def globalI: Matrix3d =
  (Matrix3d() := rot) *= objectI *= (Matrix3d() := rot.conjugated())
```

```scala
def getE(torque: IVector3d): Vector3d =
  val I = globalI
  I.inverted() * (torque - omega.cross(I * omega))
```
и симуляция вращения:

```scala
def update(dt: Double, moment: IVector3d): Unit =
  val acc = body.getE(moment)
  body.omega.madd(acc, dt)
  val dw = Quaternion().setFromExp(body.omega * 0.5 * dt)
  dw *> body.rot
  t += dt
```


## Как проверить корректность

По-сути, есть дифференциальное уравнение e = e(w, R), которое можно численно решить.

Можно проверить на [эффекте Джанибекова](https://ru.wikipedia.org/wiki/%D0%AD%D1%84%D1%84%D0%B5%D0%BA%D1%82_%D0%94%D0%B6%D0%B0%D0%BD%D0%B8%D0%B1%D0%B5%D0%BA%D0%BE%D0%B2%D0%B0) - взять тело с моментами инерции $I_x < I_y < I_z$, отправить его вращатья вокруг оси $Y$ с каким-то возмущением.

Ось вращения будет прецессировать, а вот кинетическая энергия и момент импульса - оставаться постоянными.
